<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>权限设计 | yanxlg@blog</title><meta name="description" content="前言大型前端系统功能比较繁杂，需要针对不同类型的用户开放不同的功能，因此前端需要根据不同的权限生成不同的页面，不同的路由，不同的菜单，甚至不同的交互等等，这就是前端权限系统所需要包含的内容。 常规方案在通常的前端项目中，不管是单页面还是jquery项目，一般都是通过给需要控制的组件添加id的方式进行组件控制，前端加载页面时会先获取用户的权限列表（可缓存），然后根据权限列表去针对每个受控组件进行交互"><meta name="keywords" content="react"><meta name="author" content="yanxlg"><meta name="copyright" content="yanxlg"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="cg1zWFKfJ7"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="权限设计"><meta name="twitter:description" content="前言大型前端系统功能比较繁杂，需要针对不同类型的用户开放不同的功能，因此前端需要根据不同的权限生成不同的页面，不同的路由，不同的菜单，甚至不同的交互等等，这就是前端权限系统所需要包含的内容。 常规方案在通常的前端项目中，不管是单页面还是jquery项目，一般都是通过给需要控制的组件添加id的方式进行组件控制，前端加载页面时会先获取用户的权限列表（可缓存），然后根据权限列表去针对每个受控组件进行交互"><meta name="twitter:image" content="https://blog.yanxlg.cn/images/bg.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="权限设计"><meta property="og:url" content="https://blog.yanxlg.cn/5a8a6c8d/"><meta property="og:site_name" content="yanxlg@blog"><meta property="og:description" content="前言大型前端系统功能比较繁杂，需要针对不同类型的用户开放不同的功能，因此前端需要根据不同的权限生成不同的页面，不同的路由，不同的菜单，甚至不同的交互等等，这就是前端权限系统所需要包含的内容。 常规方案在通常的前端项目中，不管是单页面还是jquery项目，一般都是通过给需要控制的组件添加id的方式进行组件控制，前端加载页面时会先获取用户的权限列表（可缓存），然后根据权限列表去针对每个受控组件进行交互"><meta property="og:image" content="https://blog.yanxlg.cn/images/bg.jpeg"><meta property="article:published_time" content="2020-07-11T09:50:13.000Z"><meta property="article:modified_time" content="2020-07-14T00:53:15.010Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://blog.yanxlg.cn/5a8a6c8d/"><link rel="prev" title="frontend" href="https://blog.yanxlg.cn/cc111e9c/"><link rel="next" title="h5/knowledge" href="https://blog.yanxlg.cn/caee5929/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: {"languages":{"author":"Author: yanxlg","link":"Link: ","source":"Source: yanxlg@blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/custom.css"><script src="/custom.js"><!-- 增加performance--><script src="/js/performance.js"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="yanxlg@blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/images/avatar.svg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">57</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">46</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">23</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/react/"><i class="fa-fw blog-icon icon-react"></i><span> React</span></a></li><li><a class="site-page" href="/categories/vue/"><i class="fa-fw blog-icon icon-vue"></i><span> Vue</span></a></li><li><a class="site-page" href="/categories/nodejs/"><i class="fa-fw blog-icon icon-node"></i><span> Nodejs</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常规方案"><span class="toc-number">2.</span> <span class="toc-text">常规方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用性需求"><span class="toc-number">3.</span> <span class="toc-text">通用性需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方案设计"><span class="toc-number">4.</span> <span class="toc-text">方案设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心代码"><span class="toc-number">5.</span> <span class="toc-text">核心代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo使用"><span class="toc-number">6.</span> <span class="toc-text">demo使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意点"><span class="toc-number">7.</span> <span class="toc-text">注意点</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/images/bg.jpeg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">yanxlg@blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/react/"><i class="fa-fw blog-icon icon-react"></i><span> React</span></a></li><li><a class="site-page" href="/categories/vue/"><i class="fa-fw blog-icon icon-vue"></i><span> Vue</span></a></li><li><a class="site-page" href="/categories/nodejs/"><i class="fa-fw blog-icon icon-node"></i><span> Nodejs</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">权限设计</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-07-11 17:50:13"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-07-11</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-07-14 08:53:15"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-07-14</span></time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>Word count:</span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>Reading time: 17 min</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><a href="/5a8a6c8d/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大型前端系统功能比较繁杂，需要针对不同类型的用户开放不同的功能，因此前端需要根据不同的权限生成<code>不同的页面</code>，<code>不同的路由</code>，<code>不同的菜单</code>，甚至<code>不同的交互</code>等等，这就是前端权限系统所需要包含的内容。</p>
<h2 id="常规方案"><a href="#常规方案" class="headerlink" title="常规方案"></a>常规方案</h2><p>在通常的前端项目中，不管是单页面还是jquery项目，一般都是通过给需要控制的组件添加id的方式进行组件控制，前端加载页面时会先获取用户的权限列表（可缓存），然后根据权限列表去针对每个受控组件进行交互控制，组件的id为扁平化方式管理，组件之间没有父子关系，这种方式比较简单，抽象出复用代码其实就等价与<code>if...else...</code>。</p>
<h2 id="通用性需求"><a href="#通用性需求" class="headerlink" title="通用性需求"></a>通用性需求</h2><ul>
<li>在常规方案中存在一些缺陷：</li>
</ul>
<ol>
<li>页面中很多类似组件，由于扁平化设计，命名id时比较麻烦，需要规避已有的（<code>接口校验</code>），但也要保持一定的语义化，因此通常采用长驼峰或者uri格式命名，保持一定的层级结构，例如<code>账号管理/角色管理/新增角色</code>按钮，id通常命名为<code>account/role/add</code>形式。</li>
<li>常规方案较简单，后台仅实现了权限的有和无，前端根据权限的处理方式完全由前端代码<code>hard code</code>处理，通用性不强，配置性不强</li>
</ol>
<ul>
<li>健壮性需求：<br>我们开发一个权限系统，需要考虑兼容性，扁平化模式属于基本模式，需要支持，同时需要支持树形权限数据，并且抽象出通用权限交互，支持后台权限配置时即可配置前端交互</li>
</ul>
<h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><ol>
<li><p>需要根据实时权限数据更新页面视图，因此需要使用React中的Provider设计。</p>
</li>
<li><p>树结构的支持需要在React中获取到父组件，通过获取权限组件链，构成真实权限路径（<code>path</code>），此实现需要对于React底层有一定的了解，了解FiberNode的相关属性，具体可参考<a href="/dee17c46/" title="&#96;React&#96;">&#96;React&#96;</a></p>
</li>
<li><p>需要支持交互配置，因此权限数据结构设计如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 控制类型，权限组件支持多样化控制方式，可权限数据中配置，可组件属性中配置，权限数据优先级&gt;组件属性</span><br><span class="line"> * render 组件级控制，不实例化组件实例</span><br><span class="line"> * display 元素级控制，实例化组件实例，但不渲染元素，与render的区别在于是否执行组件的初始化及部分生命周期；部分场景可能需要使用，例如埋点等，虽然不可见但是会触发某些操作</span><br><span class="line"> * visibility 元素级控制，隐藏元素</span><br><span class="line"> * disabled 元素级控制，不可点击</span><br><span class="line"> **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ControlType =</span><br><span class="line">    | <span class="string">"render"</span> <span class="comment">// render 控制组件创建</span></span><br><span class="line">    | <span class="string">"display"</span> <span class="comment">// 控制是否显示，UI级别比render低</span></span><br><span class="line">    | <span class="string">"visibility"</span> <span class="comment">// 控制是否隐藏，UI级别比display 低</span></span><br><span class="line">    | <span class="string">"disabled"</span> <span class="comment">// 控制是否可交互，经常用于按钮</span></span><br><span class="line">    | <span class="string">"tooltip"</span>; <span class="comment">// 用自定义的toolTip组件包裹，通常用于做提示显示，toolTip交互由传入组件自己控制</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 权限数据元素</span><br><span class="line"> * access：是否拥有该权限，默认值为true，当为false时等同于没有改权限，但是需要支持自定义属性及样式，因此需要该属性来实现控制</span><br><span class="line"> * control：控制类型，`页面级别不生效`</span><br><span class="line"> * styles：权限有无时额外样式属性，在一定程度上可以覆盖control的行为，需要受控组件支持style属性传入，`页面级别不生效`</span><br><span class="line"> *   active：有权限时自定义样式</span><br><span class="line"> *   inActive：无权限时自定义样式</span><br><span class="line"> * classNames：权限有无时额外样式表，在一定程度上可以覆盖control的行为，需要受控组件支持className属性传入，`页面级别不生效`</span><br><span class="line"> *   active：有权限时自定义样式表</span><br><span class="line"> *   inActive：无权限时自定义样式表</span><br><span class="line"> * deprecated：该权限是否被废弃</span><br><span class="line"> * children：子权限列表</span><br><span class="line"> * ==============================================</span><br><span class="line"> * 无权限数据两种方式：</span><br><span class="line"> * 一：没有该item=&gt;从组件及Provider读取control属性，默认值为render</span><br><span class="line"> * 二：item的access设置为false，从该item读取control属性及自定义属性</span><br><span class="line"> * ==============================================</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PermissionItem = &#123;</span><br><span class="line">    access?: <span class="built_in">boolean</span>; <span class="comment">// 是否有权限，默认值为true，</span></span><br><span class="line">    control?: ControlType; <span class="comment">// 设置控制类型，不同控制类型对应不同的UI交互</span></span><br><span class="line">    styles?: &#123;</span><br><span class="line">        active?: React.CSSProperties;</span><br><span class="line">        inActive?: React.CSSProperties;</span><br><span class="line">    &#125;; <span class="comment">// styles 可用于指定有权限和无权限自定义显示样式</span></span><br><span class="line">    classNames?: &#123;</span><br><span class="line">        active?: <span class="built_in">string</span>[];</span><br><span class="line">        inActive?: <span class="built_in">string</span>[];</span><br><span class="line">    &#125;;</span><br><span class="line">    deprecated?: <span class="built_in">boolean</span>; <span class="comment">// 该权限是否废弃，即可用于临时关闭某些权限限制，某些场景需要</span></span><br><span class="line">    children?: &#123;</span><br><span class="line">        [key: <span class="built_in">string</span>]: PermissionItem;</span><br><span class="line">    &#125;;</span><br><span class="line">    toolTip?: <span class="built_in">string</span>; <span class="comment">// control 为tooltip时使用属性</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> IPermissionTree = &#123;</span><br><span class="line">    [key: <span class="built_in">string</span>]: PermissionItem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>结构支持扁平化或<code>树</code>数据类型</li>
<li>支持配置交互样式</li>
<li>支持配置交互行为</li>
</ul>
</li>
<li><p>Provider 设计</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> IPermissionTree = &#123;</span><br><span class="line">    [key: <span class="built_in">string</span>]: PermissionItem;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IToolTipWrap = React.ReactElement&lt;&#123; title: <span class="built_in">string</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">interface</span> IPermissionProviderProps &#123;</span><br><span class="line">    pTree?: IPermissionTree; <span class="comment">// 拥有的权限列表</span></span><br><span class="line">    format?: <span class="string">"tree"</span> | <span class="string">"flat"</span>; <span class="comment">// 权限数据结构类型</span></span><br><span class="line">    defaultControl?: ControlType;</span><br><span class="line">    toolTipWrap?: IToolTipWrap;</span><br><span class="line">    defaultToolTip?: <span class="built_in">string</span>;</span><br><span class="line">    checkLogin?: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">boolean</span>; <span class="comment">// 外部传入用于判断登录状态的方法</span></span><br><span class="line">    history?: H.History;</span><br><span class="line">    Page_403?: React.ReactNode; <span class="comment">// 403 Page</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">interface</span> IPermissionContext <span class="keyword">extends</span> IPermissionProviderProps &#123;</span><br><span class="line">    updateTree: <span class="function">(<span class="params">tree: IPermissionTree</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext&lt;IPermissionContext&gt;(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Provider: React.FC&lt;IPermissionProviderProps&gt; = <span class="function">(<span class="params">&#123; pTree, children, ...props &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [tree, updateTree] = useState(pTree || &#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> &lt;Context.Provider value=&#123;&#123; pTree: tree, updateTree, ...props &#125;&#125;&gt;&#123;children&#125;&lt;/Context.Provider&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo&lt;PropsWithChildren&lt;IPermissionProviderProps&gt;&gt;(Provider);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; Context &#125;;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>Provider支持传入额外属性</li>
</ul>
<ol>
<li><code>format</code>：控制权限是扁平化还是<code>树</code>数据结构处理，默认是<code>树</code>数据结构，因为本文推荐使用<code>树</code>结构</li>
<li><code>defaultControl</code>：默认控制类型，如权限数据中不指定<code>control</code>属性将使用该属性来控制权限组件交互，默认值为<code>render</code></li>
<li><code>toolTipWrap</code>：当<code>control</code>为<code>tooltip</code>时需要的组件，用于展示tooltip用，本文是基于<code>ant-design</code>开发，因此，建议使用的是其<code>Tooltip</code>组件，由于组件配置属性较多，不同项目可能需要定制不同属性，因此设计为传入组件实例，使用方式<code>&lt;Tooltip title=&quot;&quot; trigger={&#39;click&#39;} /&gt;</code>，当然也可以使用其他组件或者自定义组件实例，只要满足<code>IToolTipWrap</code>定义</li>
<li><code>defaultToolTip</code>：当<code>control</code>为<code>tooltip</code>时显示的默认提示，可统一配置</li>
<li><code>checkLogin</code>：当页面组件需要登陆时，不完全依赖服务端接口去进行登陆校验，需要前端提前一步进行粗略拦截，如未登陆则自动重定向到<code>/login</code>页面</li>
<li><code>history</code>：内部使用页面跳转需要的history实例</li>
<li><code>Page_403</code>：页面组件如果无权限时使用的替代页面，内部已存在默认<code>403页面</code>，可外部使用其他组件实现自定义</li>
<li>大部分全局配置可在服务端配置实现，修改时不需要修改前端代码重新发布</li>
</ol>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><ol>
<li>组件级权限组件<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReactInstanceMap.ts</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * copy react-dom/packages/share  code to use in outside</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line">declare interface FiberNode &#123;</span><br><span class="line">    <span class="attr">elementType</span>: any;</span><br><span class="line">    pendingProps: any;</span><br><span class="line">    <span class="keyword">return</span>: any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare global &#123;</span><br><span class="line">    namespace JSX &#123;</span><br><span class="line">        interface Element &#123;</span><br><span class="line">            _owner?: FiberNode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getOwner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ownChild = <span class="xml"><span class="tag">&lt;&gt;</span><span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ownChild._owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; ReactElement, useContext, useMemo &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; IPermissionContext, ControlType, Context, IPermissionTree, PermissionItem &#125; <span class="keyword">from</span> <span class="string">"./Provider"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> assert <span class="keyword">from</span> <span class="string">"assert"</span>;</span><br><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">"classnames"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getOwner &#125; <span class="keyword">from</span> <span class="string">"./ReactInstanceMap"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> declare interface IPermissionChildProps &#123;</span><br><span class="line">    disabled?: boolean;</span><br><span class="line">    style?: React.CSSProperties;</span><br><span class="line">    className?: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> declare interface PermissionProps &#123;</span><br><span class="line">    <span class="attr">pid</span>: string;</span><br><span class="line">    fallback?: <span class="function"><span class="params">()</span> =&gt;</span> React.ReactElement; <span class="comment">// 无权限时替代组件</span></span><br><span class="line">    <span class="comment">// toolTip?:string;</span></span><br><span class="line">    children?: ReactElement&lt;IPermissionChildProps&gt;;</span><br><span class="line">    control?: ControlType; <span class="comment">// 默认control</span></span><br><span class="line">    styles?: &#123;</span><br><span class="line">        active?: React.CSSProperties;</span><br><span class="line">        inActive?: React.CSSProperties;</span><br><span class="line">    &#125;;</span><br><span class="line">    classNames?: &#123;</span><br><span class="line">        active?: string[];</span><br><span class="line">        inActive?: string[];</span><br><span class="line">    &#125;;</span><br><span class="line">    toolTipWrap?: IPermissionContext[<span class="string">"toolTipWrap"</span>];</span><br><span class="line">    toolTip?: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要缓存及局部缓存</span></span><br><span class="line"><span class="keyword">const</span> getChildren = (</span><br><span class="line">    pItem: PermissionItem | boolean,</span><br><span class="line">    <span class="attr">children</span>: ReactElement,</span><br><span class="line">    <span class="attr">defaultControl</span>: ControlType,</span><br><span class="line">    customStyles?: PermissionItem[<span class="string">"styles"</span>],</span><br><span class="line">    customClassNames?: PermissionItem[<span class="string">"classNames"</span>],</span><br><span class="line">    fallback?: PermissionProps[<span class="string">"fallback"</span>],</span><br><span class="line">    toolTipWrap?: PermissionProps[<span class="string">"toolTipWrap"</span>],</span><br><span class="line">    defaultToolTip?: string,</span><br><span class="line">    toolTip?: string,</span><br><span class="line">    extraProps?: any</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 设置children属性</span></span><br><span class="line">    <span class="keyword">if</span> (pItem === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> children; <span class="comment">// 废弃</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> item: PermissionItem =</span><br><span class="line">        <span class="keyword">typeof</span> pItem === <span class="string">"boolean"</span></span><br><span class="line">            ? &#123;</span><br><span class="line">                  <span class="attr">control</span>: defaultControl,</span><br><span class="line">                  <span class="attr">access</span>: pItem</span><br><span class="line">              &#125;</span><br><span class="line">            : pItem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; access = <span class="literal">true</span>, styles, <span class="attr">classNames</span>: classes, control &#125; = item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> style = access ? styles?.active : styles?.inActive;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> customStyle = access ? customStyles?.active : customStyles?.inActive;</span><br><span class="line">    <span class="keyword">const</span> customClassName = access ? customClassNames?.active : customClassNames?.inActive;</span><br><span class="line">    <span class="keyword">const</span> mergeClassName = classNames(children.props?.className, access ? classes?.active : classes?.inActive, customClassName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mergeStyle = &#123;</span><br><span class="line">        ...children.props?.style,</span><br><span class="line">        ...(control === <span class="string">"display"</span> &amp;&amp; !access ? &#123; <span class="attr">display</span>: <span class="string">"none"</span> &#125; : control === <span class="string">"visibility"</span> &amp;&amp; !access ? &#123; <span class="attr">visibility</span>: <span class="string">"hidden"</span> &#125; : &#123;&#125;),</span><br><span class="line">        ...style,</span><br><span class="line">        ...customStyle</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mergeProps = &#123;</span><br><span class="line">        ...children.props,</span><br><span class="line">        <span class="attr">style</span>: mergeStyle,</span><br><span class="line">        <span class="attr">className</span>: mergeClassName,</span><br><span class="line">        ...(control === <span class="string">"disabled"</span> &amp;&amp; !access ? &#123; <span class="attr">disabled</span>: <span class="literal">true</span> &#125; : &#123;&#125;),</span><br><span class="line">        ...extraProps</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// fallback优先级最高</span></span><br><span class="line">    <span class="keyword">if</span> (!access &amp;&amp; fallback) &#123;</span><br><span class="line">        <span class="keyword">return</span> fallback();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> _toolTip = item.toolTip || toolTip || defaultToolTip;</span><br><span class="line">    <span class="keyword">if</span> (control === <span class="string">"tooltip"</span> || toolTip) &#123;</span><br><span class="line">        <span class="comment">// 组件props上tooltip强制覆盖</span></span><br><span class="line">        assert(_toolTip, <span class="string">"Permission ToolTip control must have tooltip property."</span>);</span><br><span class="line">        assert(toolTipWrap, <span class="string">"Permission ToolTip control must have toolTipWrap component."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fix Popconfirm</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"onConfirm"</span> <span class="keyword">in</span> mergeProps) &#123;</span><br><span class="line">            mergeProps.disabled = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mergeProps.popConfirmProps &amp;&amp; <span class="string">"onConfirm"</span> <span class="keyword">in</span> mergeProps.popConfirmProps) &#123;</span><br><span class="line">            mergeProps.popConfirmProps.disabled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_toolTip &amp;&amp; toolTipWrap &amp;&amp; !access) &#123;</span><br><span class="line">            <span class="comment">// children 为disabled状态</span></span><br><span class="line">            <span class="keyword">const</span> child = React.cloneElement(children, &#123; ...mergeProps, <span class="attr">onClick</span>: <span class="literal">undefined</span>, <span class="attr">_privateClick</span>: <span class="literal">true</span> &#125;, children.props?.children); <span class="comment">// onClick去掉</span></span><br><span class="line">            <span class="keyword">if</span> (children.props?.disabled) &#123;</span><br><span class="line">                <span class="keyword">return</span> child;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> React.cloneElement(</span><br><span class="line">                toolTipWrap,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">title</span>: _toolTip</span><br><span class="line">                &#125;,</span><br><span class="line">                child</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (control === <span class="string">"render"</span> &amp;&amp; !access) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> React.cloneElement(children, mergeProps, children.props?.children);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPidList = <span class="function">(<span class="params">instance: any, format: IPermissionContext[<span class="string">"format"</span>], pid: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (format === <span class="string">"flat"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [pid]; <span class="comment">// 扁平化，根键值对</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> permissions = [];</span><br><span class="line">        <span class="keyword">let</span> parent = instance;</span><br><span class="line">        <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent.elementType === PermissionComponent || parent.elementType?.type === PermissionComponent) &#123;</span><br><span class="line">                permissions.unshift(parent.pendingProps.pid);</span><br><span class="line">            &#125;</span><br><span class="line">            parent = parent.return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 判断是否有权限</span><br><span class="line"> * @param pidList</span><br><span class="line"> * @param pidMap</span><br><span class="line"> * @return boolean|PermissionItem  true:废弃，不做处理，false：无权限，PermissionItem：权限控制Item</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> checkPermission = <span class="function">(<span class="params">pidList: string[], pidMap: IPermissionTree</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> length = pidList.length;</span><br><span class="line">    <span class="keyword">let</span> access: boolean | PermissionItem = <span class="literal">false</span>,</span><br><span class="line">        i = <span class="number">0</span>,</span><br><span class="line">        next = pidMap,</span><br><span class="line">        cur = next[pidList[i]];</span><br><span class="line">    <span class="keyword">while</span> (!access &amp;&amp; cur &amp;&amp; i &lt; length) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur.deprecated) &#123;</span><br><span class="line">            <span class="comment">// 废弃</span></span><br><span class="line">            access = <span class="literal">true</span>; <span class="comment">// 对于废弃的不做权限处理</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">                next = cur.children;</span><br><span class="line">                <span class="keyword">if</span> (!next) &#123;</span><br><span class="line">                    cur = <span class="literal">undefined</span>;</span><br><span class="line">                    i = length; <span class="comment">//退出循环</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cur = next[pidList[i]];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i === length &amp;&amp; cur) &#123;</span><br><span class="line">                    access = cur.deprecated ? <span class="literal">true</span> : cur;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                access = cur.deprecated ? <span class="literal">true</span> : cur;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> access;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PermissionComponent = <span class="function">(<span class="params">props: PermissionProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; pid, fallback, children, control, styles, classNames, <span class="attr">toolTipWrap</span>: _toolTipWrap, toolTip, ...extra &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> context = useContext(Context);</span><br><span class="line">    assert(context !== <span class="literal">null</span>, <span class="string">"Permission Component must be used by wrapped with PermissionProvider"</span>);</span><br><span class="line">    assert(pid, <span class="string">"Permission Component must have pid"</span>);</span><br><span class="line">    assert(children, <span class="string">"Permission Component must have children"</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; format, pTree &#125; = context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> owner = getOwner();</span><br><span class="line">    <span class="keyword">const</span> pidList = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> getPidList(owner, format, pid), []);</span><br><span class="line">    <span class="keyword">const</span> check = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> checkPermission(pidList, pTree), [pTree]);</span><br><span class="line">    <span class="keyword">const</span> toolTipWrap = _toolTipWrap || context.toolTipWrap;</span><br><span class="line">    <span class="comment">// 缓存创建节点</span></span><br><span class="line">    <span class="keyword">return</span> useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getChildren(check, children, control || context.defaultControl || <span class="string">"render"</span>, styles, classNames, fallback, toolTipWrap, context.defaultToolTip, toolTip, extra);</span><br><span class="line">    &#125;, [children, pTree]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usePermissionFilter = (</span><br><span class="line">    items: <span class="built_in">Array</span>&lt;&#123;</span><br><span class="line">        <span class="attr">pid</span>: string;</span><br><span class="line">        [key: string]: any;</span><br><span class="line">    &#125;&gt;</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> context = useContext(Context);</span><br><span class="line">    <span class="keyword">const</span> &#123; format, pTree &#125; = context;</span><br><span class="line">    <span class="keyword">const</span> owner = getOwner();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.filter(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> pidList = getPidList(owner, format, item.pid);</span><br><span class="line">            <span class="keyword">const</span> check = checkPermission(pidList, pTree);</span><br><span class="line">            <span class="keyword">return</span> check === <span class="literal">true</span> || (<span class="keyword">typeof</span> check === <span class="string">"object"</span> &amp;&amp; (check.access === <span class="keyword">void</span> <span class="number">0</span> || check.access === <span class="literal">true</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;, [items, pTree]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo&lt;PermissionProps&gt;(PermissionComponent);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; usePermissionFilter &#125;;</span><br></pre></td></tr></table></figure></li>
<li>页面级权限组件<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PropsWithChildren, useCallback, useContext, useMemo &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">"./Provider"</span>;</span><br><span class="line"><span class="keyword">import</span> assert <span class="keyword">from</span> <span class="string">"assert"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> H <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getOwner &#125; <span class="keyword">from</span> <span class="string">"./ReactInstanceMap"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; checkPermission, getPidList &#125; <span class="keyword">from</span> <span class="string">"./ComponentPermission"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> declare interface IRouterPermission &#123;</span><br><span class="line">    login?: boolean; <span class="comment">// 是否需要登录</span></span><br><span class="line">    history?: H.History;</span><br><span class="line">    pid: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RouterPermission: React.FC&lt;IRouterPermission&gt; = <span class="function">(<span class="params">&#123; login, pid, history, children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 是否登录，是否拥有该页面权限，可能是子页面</span></span><br><span class="line">    <span class="keyword">const</span> context = useContext(Context);</span><br><span class="line">    <span class="keyword">const</span> &#123; checkLogin, format, pTree, Page_403 &#125; = context;</span><br><span class="line">    <span class="keyword">if</span> (login) &#123;</span><br><span class="line">        assert(checkLogin, <span class="string">"login check require checkLogin function."</span>);</span><br><span class="line">        <span class="keyword">const</span> isLogin = checkLogin?.();</span><br><span class="line">        <span class="keyword">if</span> (!isLogin) &#123;</span><br><span class="line">            assert(history || context.history, <span class="string">"redirect must have history property."</span>);</span><br><span class="line">            <span class="comment">// 未登录</span></span><br><span class="line">            (history || context.history)?.replace(<span class="string">"/login"</span>); <span class="comment">// 跳转登录，登录页面支持重定向</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断路由权限</span></span><br><span class="line">    <span class="keyword">const</span> owner = getOwner();</span><br><span class="line">    <span class="keyword">const</span> pidList = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> getPidList(owner, format, pid), []);</span><br><span class="line">    <span class="keyword">const</span> check = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> checkPermission(pidList, pTree), [pTree]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> goHome = useCallback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        (history || context.history)?.replace(<span class="string">"/"</span>);</span><br><span class="line">    &#125;, []);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check === <span class="literal">true</span> || (<span class="keyword">typeof</span> check === <span class="string">"object"</span> &amp;&amp; check.access !== <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;&gt;</span>&#123;children&#125;<span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Page_403 ? (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;&gt;</span>&#123;Page_403&#125;<span class="tag">&lt;/&gt;</span></span></span><br><span class="line">        ) : (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">textAlign:</span> "<span class="attr">center</span>", <span class="attr">color:</span> "<span class="attr">rgba</span>(<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">.85</span>)", <span class="attr">fontSize:</span> <span class="attr">24</span>, <span class="attr">lineHeight:</span> <span class="attr">1.8</span> &#125;&#125;&gt;</span>403<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span></span><br><span class="line">                    <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span><br><span class="line">                        <span class="attr">color:</span> "<span class="attr">rgba</span>(<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">.45</span>)",</span><br><span class="line">                        <span class="attr">fontSize:</span> <span class="attr">14</span>,</span><br><span class="line">                        <span class="attr">lineHeight:</span> <span class="attr">1.6</span>,</span><br><span class="line">                        <span class="attr">textAlign:</span> "<span class="attr">center</span>"</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                &gt;</span></span><br><span class="line">                    Sorry, you don't have access to this page.</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">textAlign:</span> "<span class="attr">center</span>" &#125;&#125;&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span></span><br><span class="line">                        <span class="attr">onClick</span>=<span class="string">&#123;goHome&#125;</span></span><br><span class="line">                        <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span><br><span class="line">                            <span class="attr">color:</span> "#<span class="attr">fff</span>",</span><br><span class="line">                            <span class="attr">background:</span> "#<span class="attr">1890ff</span>",</span><br><span class="line">                            <span class="attr">borderColor:</span> "#<span class="attr">1890ff</span>",</span><br><span class="line">                            <span class="attr">textShadow:</span> "<span class="attr">0</span> <span class="attr">-1px</span> <span class="attr">0</span> <span class="attr">rgba</span>(<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">.12</span>)",</span><br><span class="line">                            <span class="attr">boxShadow:</span> "<span class="attr">0</span> <span class="attr">2px</span> <span class="attr">0</span> <span class="attr">rgba</span>(<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">0</span>,<span class="attr">.045</span>)",</span><br><span class="line">                            <span class="attr">textAlign:</span> "<span class="attr">center</span>",</span><br><span class="line">                            <span class="attr">cursor:</span> "<span class="attr">pointer</span>",</span><br><span class="line">                            <span class="attr">height:</span> <span class="attr">32</span>,</span><br><span class="line">                            <span class="attr">padding:</span> "<span class="attr">4px</span> <span class="attr">15px</span>",</span><br><span class="line">                            <span class="attr">fontSize:</span> <span class="attr">14</span>,</span><br><span class="line">                            <span class="attr">borderRadius:</span> <span class="attr">2</span>,</span><br><span class="line">                            <span class="attr">border:</span> "<span class="attr">1px</span> <span class="attr">solid</span> #<span class="attr">d9d9d9</span>",</span><br><span class="line">                            <span class="attr">outline:</span> "<span class="attr">none</span>"</span><br><span class="line">                        &#125;&#125;</span><br><span class="line">                    &gt;</span></span><br><span class="line">                        Back to home</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo&lt;PropsWithChildren&lt;IRouterPermission&gt;&gt;(RouterPermission);</span><br></pre></td></tr></table></figure></li>
<li><code>decorators</code>：为了简化类组件的使用，提供装饰器模式支持<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * decorator + wrap support</span><br><span class="line"> * 支持同一类组件中权限控制</span><br><span class="line"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ReactElement &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ComponentPermission, &#123; IPermissionChildProps, PermissionProps &#125; <span class="keyword">from</span> <span class="string">"./ComponentPermission"</span>;</span><br><span class="line"><span class="keyword">import</span> RouterPermission, &#123; IRouterPermission &#125; <span class="keyword">from</span> <span class="string">"./RouterPermission"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ComponentPermissionWrap = <span class="function">(<span class="params">children: ReactElement&lt;IPermissionChildProps&gt;, props: Omit&lt;PermissionProps, <span class="string">"children"</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">ComponentPermission</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">children</span>=<span class="string">&#123;children&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RouterPermissionWrap = <span class="function">(<span class="params">children: React.ReactNode, props: IRouterPermission</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">RouterPermission</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">children</span>=<span class="string">&#123;children&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type RouterPermissionProps = &#123;</span><br><span class="line">    <span class="attr">router</span>: <span class="literal">true</span>;</span><br><span class="line">&#125; &amp; IRouterPermission;</span><br><span class="line"></span><br><span class="line">type ComponentPermissionProps = &#123;</span><br><span class="line">    router?: <span class="literal">false</span>;</span><br><span class="line">&#125; &amp; Omit&lt;PermissionProps, <span class="string">"children"</span>&gt;;</span><br><span class="line"></span><br><span class="line">type IPProps = RouterPermissionProps | ComponentPermissionProps;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type RouterClass = React.ComponentClass&lt;any, any&gt;;</span></span><br><span class="line"></span><br><span class="line">type ComponentClass&lt;T extends IPermissionChildProps&gt; = React.ComponentClass&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">type IIPermissionChildProps = IPermissionChildProps &amp; &#123;</span><br><span class="line">    [key: string]: any;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Class Decorator</span><br><span class="line"> * @param config</span><br><span class="line"> * @constructor</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Permission</span>&lt;<span class="title">T</span>&gt;(<span class="params">config: IPProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; router, ..._config &#125; = config;</span><br><span class="line">    <span class="keyword">if</span> (router) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">any</span>&gt;(<span class="params">WrappedComponent: ComponentClass&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span>(<span class="params">props: any</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RouterPermissionWrap(<span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>, _config);</span><br><span class="line">            &#125; <span class="keyword">as</span> unknown) <span class="keyword">as</span> any;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">IIPermissionChildProps</span>&gt;(<span class="params">WrappedComponent: ComponentClass&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span>(<span class="params">props: any</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ComponentPermissionWrap(<span class="xml"><span class="tag">&lt;<span class="name">WrappedComponent</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>, _config);</span><br><span class="line">            &#125; <span class="keyword">as</span> unknown) <span class="keyword">as</span> any;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; Permission &#125;;</span><br></pre></td></tr></table></figure></li>
<li><code>wrapper</code>：函数式组件无法使用<code>decorator</code>，因此提供额外<code>wrapper</code>方式<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PermissionRouterWrap = <span class="function">(<span class="params">Component: React.ComponentClass&lt;any, any&gt; | React.FC&lt;any&gt;, config: IRouterPermission</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">props: any</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">PermissionRouter</span> &#123;<span class="attr">...config</span>&#125;&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">PermissionRouter</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PermissionComponentWrap = &lt;T,&gt;(Component: React.ComponentClass&lt;T, any&gt; | React.FC&lt;T&gt;, config: Omit&lt;PermissionProps, "children"&gt;) =&gt; &#123;</span><br><span class="line">    return (props: T) =&gt; &#123;</span><br><span class="line">        return (</span><br><span class="line">            &lt;PermissionComponent &#123;...config&#125;&gt;</span><br><span class="line">                &lt;Component &#123;...props&#125; /&gt;</span><br><span class="line">            &lt;/PermissionComponent&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="demo使用"><a href="#demo使用" class="headerlink" title="demo使用"></a>demo使用</h2><ol>
<li>tree 结构使用<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;PermissionProvider</span><br><span class="line">    pTree=&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"111"</span>: &#123;</span><br><span class="line">                <span class="attr">children</span>: &#123;</span><br><span class="line">                    <span class="string">"2222"</span>: &#123;</span><br><span class="line">                        <span class="attr">access</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">styles</span>: &#123;</span><br><span class="line">                            <span class="attr">active</span>: &#123;</span><br><span class="line">                                <span class="attr">backgroundColor</span>: <span class="string">"red"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">inActive</span>: &#123;</span><br><span class="line">                                <span class="attr">backgroundColor</span>: <span class="string">"green"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">as</span> IPermissionTree</span><br><span class="line">    &#125;</span><br><span class="line">&gt;</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        dsads</span><br><span class="line">        <span class="tag">&lt;<span class="name">PermissionComponent</span> <span class="attr">pid</span>=<span class="string">&#123;</span>"<span class="attr">111</span>"&#125;&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">PermissionComponent</span> <span class="attr">pid</span>=<span class="string">&#123;</span>"<span class="attr">2222</span>"&#125; <span class="attr">toolTipWrap</span>=<span class="string">&#123;toolTip&#125;</span> <span class="attr">toolTip</span>=<span class="string">&#123;</span>"我是提示信息"&#125;&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span>122<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">PermissionComponent</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">B</span> <span class="attr">text</span>=<span class="string">"yyyyyyy"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">PermissionComponent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/PermissionProvider&gt;</span><br></pre></td></tr></table></figure></li>
<li><code>umijs</code>项目中使用<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.tsx</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">rootContainer</span>(<span class="params">container: any</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> React.createElement(</span><br><span class="line">        PermissionProvider,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">format</span>: <span class="string">'flat'</span>,</span><br><span class="line">            <span class="attr">checkLogin</span>: <span class="function"><span class="params">()</span> =&gt;</span> !!User.token,</span><br><span class="line">            <span class="attr">history</span>: history,</span><br><span class="line">            <span class="attr">Page_403</span>: <span class="xml"><span class="tag">&lt;<span class="name">Page</span> /&gt;</span></span>,</span><br><span class="line">            pTree: User.pData, <span class="comment">// 缓存权限列表</span></span><br><span class="line">            <span class="attr">toolTipWrap</span>: <span class="xml"><span class="tag">&lt;<span class="name">Tooltip</span> <span class="attr">title</span>=<span class="string">""</span> <span class="attr">trigger</span>=<span class="string">&#123;</span>'<span class="attr">click</span>'&#125; /&gt;</span></span>,</span><br><span class="line">            defaultToolTip: <span class="string">'账号无此权限，请联系管理员！'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        container,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PermissionRouterWrap(GoodsAttr, &#123;</span><br><span class="line">    login: <span class="literal">true</span>,</span><br><span class="line">    pid: <span class="string">'setting/goods_attr'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交互组件</span></span><br><span class="line">&lt;PermissionComponent</span><br><span class="line">    pid=<span class="string">"setting/export/delete"</span></span><br><span class="line">    control=<span class="string">"tooltip"</span></span><br><span class="line">&gt;</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">CloseOutlined</span></span><br><span class="line">        <span class="attr">className</span>=<span class="string">&#123;exportStyles.exportClose&#125;</span></span><br><span class="line">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> deleteFile(id)&#125;</span><br><span class="line">    /&gt;</span></span><br><span class="line">&lt;/PermissionComponent&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ol>
<li>由于受控组件外部嵌套一层权限组件，如之前父组件中使用了React.cloneElement或者React.createElement会将属性添加到权限组件中，权限组件已尽量将不想管属性向下传递，需要的属性命名尽量不常用，但也会出现偶然性冲突问题，需要在使用时注意。</li>
<li>不支持扁平化与<code>树</code>结构混用，推荐使用一种方式，而不是混合使用</li>
<li><code>树</code>结构如果出现多个页面重复功能时，如两个页面都有审核功能，主观上设计应该避免，同样的入口会对用户造成迷惑性，但一般来说还是不可避免会出现这种情况，在使用<code>树</code>结构时需要每个页面下都有该功能权限配置，唯一比较好的办法是配置页面中将该权限提升到与页面同级，如果选中则分别映射到两个页面下。</li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">yanxlg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yanxlg.cn/5a8a6c8d/">https://blog.yanxlg.cn/5a8a6c8d/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/react/">react</a></div><div class="post_share"><div class="social-share" data-image="/images/bg.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/images/wechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/images/alipay.png" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/cc111e9c/"><img class="prev_cover" data-src="/images/top/frontend.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">frontend</div></div></a></div><div class="next-post pull_right"><a href="/caee5929/"><img class="next_cover" data-src="/images/bg.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">h5/knowledge</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/9bcaf31a/" title="Call setState when unMounted"><img class="relatedPosts_cover" data-src="/images/bg.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-03-20</div><div class="relatedPosts_title">Call setState when unMounted</div></div></a></div><div class="relatedPosts_item"><a href="/963d3ca1/" title="React 性能优化"><img class="relatedPosts_cover" data-src="/images/bg.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-20</div><div class="relatedPosts_title">React 性能优化</div></div></a></div><div class="relatedPosts_item"><a href="/dee17c46/" title="React"><img class="relatedPosts_cover" data-src="/images/top/react.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-20</div><div class="relatedPosts_title">React</div></div></a></div><div class="relatedPosts_item"><a href="/1b5b7ecc/" title="React 服务端渲染"><img class="relatedPosts_cover" data-src="/images/bg.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-20</div><div class="relatedPosts_title">React 服务端渲染</div></div></a></div><div class="relatedPosts_item"><a href="/5c7548aa/" title="React 模块化服务端渲染"><img class="relatedPosts_cover" data-src="/images/bg.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-09-20</div><div class="relatedPosts_title">React 模块化服务端渲染</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '12a1217ff53b08c6c73a',
  clientSecret: '7ee99a0195d3d7837a04a7eeb423f98c960d9f60',
  repo: 'yanxlg.github.io',
  owner: 'yanxlg',
  admin: ['yanxlg'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By yanxlg</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="150" mobile="false" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/click_heart.js"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>